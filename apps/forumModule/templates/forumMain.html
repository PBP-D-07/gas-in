{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>gas.in | Forum</title>
{% endblock meta %}

{% block content %}
<div class="forum-wrapper">
  <div class="forum-container">
    <!-- Header -->
    <div class="forum-header">
      <div>
        <h1 class="forum-title">Community Forum</h1>
        <p class="forum-subtitle">Share your fitness journey with the community</p>
      </div>
      
      {% if user.is_authenticated %}
      <button id="openCreatePostModal" class="btn-create">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
          <path d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"/>
        </svg>
        Create Post
      </button>
      {% endif %}
    </div>

    <!-- Filter Tabs -->
    <div class="filter-tabs">
      <button id="filter-all" class="tab active">
        <span>For You</span>
      </button>
      {% if user.is_authenticated %}
      <button id="filter-my" class="tab">
        <span>My Posts</span>
      </button>
      {% endif %}
    </div>

    <!-- Posts Container -->
    <div id="posts-container" class="posts-feed">
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading posts...</p>
      </div>
    </div>
  </div>
</div>

<!-- Modal Create Post -->
<div id="createPostModal" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h2>Create New Post</h2>
      <button id="closeCreatePostModal" class="btn-close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <form id="createPostForm" class="modal-form">
      {% csrf_token %}
      
      <div class="form-group">
        <label>Category</label>
        <select name="category" required>
          <option value="running">üèÉ Running</option>
          <option value="workout">üí™ Workout</option>
          <option value="nutrition">ü•ó Nutrition</option>
          <option value="event">üìÖ Event</option>
          <option value="recovery">üßò Recovery</option>
          <option value="motivation">‚ö° Motivation</option>
        </select>
      </div>

      <div class="form-group">
        <label>Description</label>
        <textarea name="description" rows="5" placeholder="What's on your mind?" required></textarea>
      </div>

      <div class="form-group">
        <label>Thumbnail URL <span>(optional)</span></label>
        <input type="url" name="thumbnail" placeholder="https://example.com/image.jpg">
      </div>

      <div class="modal-actions">
        <button type="button" id="cancelCreatePost" class="btn-secondary">Cancel</button>
        <button type="submit" class="btn-primary">Publish</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Edit Post -->
<div id="editPostModal" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h2>Edit Post</h2>
      <button id="closeEditPostModal" class="btn-close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <form id="editPostForm" class="modal-form">
      {% csrf_token %}
      <input type="hidden" name="post_id" id="edit-post-id">

      <div class="form-group">
        <label>Category</label>
        <select name="category" id="edit-category" required>
          <option value="running">üèÉ Running</option>
          <option value="workout">üí™ Workout</option>
          <option value="nutrition">ü•ó Nutrition</option>
          <option value="event">üìÖ Event</option>
          <option value="recovery">üßò Recovery</option>
          <option value="motivation">‚ö° Motivation</option>
        </select>
      </div>

      <div class="form-group">
        <label>Description</label>
        <textarea name="description" id="edit-description" rows="5" required></textarea>
      </div>

      <div class="form-group">
        <label>Thumbnail URL <span>(optional)</span></label>
        <input type="url" name="thumbnail" id="edit-thumbnail" placeholder="https://example.com/image.jpg">
      </div>

      <div class="modal-actions">
        <button type="button" id="cancelEditPost" class="btn-secondary">Cancel</button>
        <button type="submit" class="btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Comments -->
<div id="commentModal" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h2>Comments</h2>
      <button id="closeCommentModal" class="btn-close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>
    
    <div id="commentsList" class="comments-list"></div>
    
    {% if user.is_authenticated %}
    <form id="commentForm" class="comment-form">
      {% csrf_token %}
      <input type="hidden" id="commentPostId">
      <textarea id="commentContent" rows="3" placeholder="Write a comment..." required></textarea>
      <button type="submit" class="btn-primary">Send</button>
    </form>
    {% else %}
    <p class="login-prompt">Please login to comment</p>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const postsContainer = document.getElementById('posts-container');
    const filterAllBtn = document.getElementById('filter-all');
    const filterMyBtn = document.getElementById('filter-my');
    const userId = "{{ user.id }}";

    // Category colors & icons
    const categoryMeta = {
      'running': { color: '#FF6B35', icon: 'üèÉ', label: 'Running' },
      'workout': { color: '#E63946', icon: 'üí™', label: 'Workout' },
      'nutrition': { color: '#06A77D', icon: 'ü•ó', label: 'Nutrition' },
      'event': { color: '#3B82F6', icon: 'üìÖ', label: 'Event' },
      'recovery': { color: '#14B8A6', icon: 'üßò', label: 'Recovery' },
      'motivation': { color: '#8B5CF6', icon: '‚ö°', label: 'Motivation' }
    };

    // Helper: Get CSRF Token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === name + "=") {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Load Posts
    async function loadPosts(filter = "all") {
      postsContainer.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Loading posts...</p></div>';
      
      try {
        const response = await fetch("{% url 'forumModule:show_json' %}");
        if (!response.ok) throw new Error('Failed to fetch posts');
        
        const posts = await response.json();
        postsContainer.innerHTML = "";

        const filteredPosts = filter === "my"
          ? posts.filter(p => String(p.owner_id) === String(userId))
          : posts;

        if (filteredPosts.length === 0) {
          postsContainer.innerHTML = '<div class="empty-state"><p>No posts yet. Be the first to share!</p></div>';
          return;
        }

        filteredPosts.forEach(post => {
          const category = categoryMeta[post.category] || categoryMeta['running'];
          const postElement = document.createElement("article");
          postElement.className = "post-card";

          postElement.innerHTML = `
            <div class="post-avatar">
              <img src="/static/image/profile.png" alt="${post.owner_username}">
            </div>
            
            <div class="post-content">
              <div class="post-header">
                <span class="post-author">${post.owner_username || "Unknown"}</span>
                <span class="post-meta">
                  <span class="category-badge" style="background: ${category.color}20; color: ${category.color}">
                    ${category.icon} ${category.label}
                  </span>
                  ‚Ä¢ ${timeAgo(post.created_at)}
                </span>
              </div>

              <p class="post-description">${post.description || "No description"}</p>
              
              ${post.thumbnail ? `<img src="${post.thumbnail}" alt="Post image" class="post-image" onerror="this.style.display='none'">` : ""}

              <div class="post-actions">
                <button onclick="toggleLike('${post.id}')" id="like-btn-${post.id}" class="action-btn">
                  <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91z"/>
                  </svg>
                  <span>${post.like_count || 0}</span>
                </button>

                <button onclick="openCommentModal('${post.id}')" class="action-btn">
                  <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M1.751 10c0-4.42 3.584-8 8.005-8h4.366c4.49 0 8.129 3.64 8.129 8.13 0 2.96-1.607 5.68-4.196 7.11l-8.054 4.46v-3.69h-.067c-4.49.1-8.183-3.51-8.183-8.01zm8.005-6c-3.317 0-6.005 2.69-6.005 6 0 3.37 2.77 6.08 6.138 6.01l.351-.01h1.761v2.3l5.087-2.81c1.951-1.08 3.163-3.13 3.163-5.36 0-3.39-2.744-6.13-6.129-6.13H9.756z"/>
                  </svg>
                </button>

                <div class="action-btn views">
                  <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M8.75 21V3h2v18h-2zM18 21V8.5h2V21h-2zM4 21l.004-10h2L6 21H4zm9.248 0v-7h2v7h-2z"/>
                  </svg>
                  <span>${post.post_views || 0}</span>
                </div>

                <a href="/forum/${post.id}/" class="action-btn">
                  <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M12 2.59l5.7 5.7-1.41 1.42L13 6.41V16h-2V6.41l-3.3 3.3-1.41-1.42L12 2.59z"/>
                  </svg>
                </a>

                ${String(post.owner_id) === String(userId) ? `
                  <button onclick="openEditModal('${post.id}')" class="action-btn edit">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                  </button>
                  <button onclick="deletePost('${post.id}')" class="action-btn delete">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                      <path d="M16 6V4.5C16 3.12 14.88 2 13.5 2h-3C9.11 2 8 3.12 8 4.5V6H3v2h1.06l.81 11.21C4.98 20.78 6.28 22 7.86 22h8.27c1.58 0 2.88-1.22 3-2.79L19.93 8H21V6h-5zm-6-1.5c0-.28.22-.5.5-.5h3c.27 0 .5.22.5.5V6h-4V4.5z"/>
                    </svg>
                  </button>
                ` : ""}
              </div>
            </div>
          `;
          
          postsContainer.appendChild(postElement);
        });

      } catch (error) {
        console.error('Error loading posts:', error);
        postsContainer.innerHTML = `<div class="error-state"><p>Failed to load posts. Please try again.</p></div>`;
      }
    }

    // Time ago helper
    function timeAgo(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const seconds = Math.floor((now - date) / 1000);
      
      if (seconds < 60) return 'just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
      
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Toggle Like
    window.toggleLike = async function(postId) {
      try {
        const response = await fetch(`/forum/like/${postId}/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie('csrftoken'),
            "X-Requested-With": "XMLHttpRequest",
          },
        });
        
        if (response.ok) {
          const data = await response.json();
          const likeBtn = document.getElementById(`like-btn-${postId}`);
          if (likeBtn) {
            likeBtn.querySelector('span').textContent = data.like_count;
            if (data.liked) {
              likeBtn.classList.add('liked');
            } else {
              likeBtn.classList.remove('liked');
            }
          }
        }
      } catch (error) {
        console.error("Error:", error);
      }
    };

    // Delete Post
    window.deletePost = async function(postId) {
      if (!confirm('Are you sure you want to delete this post?')) return;

      try {
        const response = await fetch(`/forum/delete/${postId}/`, {
          method: 'POST',
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": getCookie('csrftoken'),
          },
        });

        if (response.ok) {
          loadPosts();
        }
      } catch (error) {
        console.error('Error:', error);
      }
    };

    // Edit Modal
    window.openEditModal = async function(postId) {
      try {
        const response = await fetch(`/forum/json/${postId}/`);
        const post = await response.json();

        document.getElementById("edit-post-id").value = post.id;
        document.getElementById("edit-category").value = post.category;
        document.getElementById("edit-description").value = post.description;
        document.getElementById("edit-thumbnail").value = post.thumbnail || "";

        document.getElementById("editPostModal").classList.add("show");
      } catch (error) {
        console.error("Error:", error);
      }
    };

    // Comment Modal
    window.openCommentModal = async function(postId) {
  document.getElementById("commentModal").classList.add("show");
  document.getElementById("commentPostId").value = postId;

  // ambil post data
  let post;
  try {
    const response = await fetch(`/forum/json/${postId}/`);
    post = await response.json();
  } catch (error) {
    console.error("Error fetching post:", error);
    return;
  }

  const commentsList = document.getElementById('commentsList');
  commentsList.innerHTML = '<div class="loading-comments"><div class="spinner-sm"></div></div>';

  // enable/disable comment form
  const commentContent = document.getElementById('commentContent');
  const commentBtn = document.querySelector('#commentForm button[type="submit"]');
  if (post.owner_id == null) { // dummy post
    if (commentContent) commentContent.disabled = true;
    if (commentBtn) {
      commentBtn.disabled = true;
      commentBtn.textContent = 'Read-only';
      commentBtn.className = "px-6 py-2 text-white font-semibold rounded-xl bg-gradient-to-r from-indigo-300 to-purple-300 cursor-not-allowed select-none opacity-80";
    }
  } else { // real user post
    if (commentContent) commentContent.disabled = false;
    if (commentBtn) {
      commentBtn.disabled = false;
      commentBtn.textContent = 'Send';
      commentBtn.className = "px-6 py-2 text-white font-semibold rounded-2xl bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 transition-all";
    }
  }

  // load comments
  try {
    const response = await fetch(`/forum/comment/${postId}/`);
    const comments = await response.json();

    if (!comments || comments.length === 0) {
      commentsList.innerHTML = '<p class="no-comments">No comments yet</p>';
      return;
    }

    commentsList.innerHTML = comments.map(c => `
      <div class="comment-item">
        <div class="comment-avatar">${c.user.charAt(0).toUpperCase()}</div>
        <div class="comment-content">
          <div class="comment-header">
            <span class="comment-author">${c.user}</span>
            <span class="comment-time">${timeAgo(c.created_at)}</span>
          </div>
          <p>${c.content}</p>
        </div>
      </div>
    `).join('');

  } catch (error) {
    commentsList.innerHTML = '<p class="no-comments">Failed to load comments</p>';
  }
};



    async function loadComments(postId) {
      const commentsList = document.getElementById('commentsList');
      commentsList.innerHTML = '<div class="loading-comments"><div class="spinner-sm"></div></div>';

      try {
        const response = await fetch(`/forum/comment/${postId}/`);
        const comments = await response.json();

        if (comments.length === 0) {
          commentsList.innerHTML = '<p class="no-comments">No comments yet</p>';
          return;
        }

        commentsList.innerHTML = comments.map(c => `
          <div class="comment-item">
            <div class="comment-avatar">${c.user.charAt(0).toUpperCase()}</div>
            <div class="comment-content">
              <div class="comment-header">
                <span class="comment-author">${c.user}</span>
                <span class="comment-time">${timeAgo(c.created_at)}</span>
              </div>
              <p>${c.content}</p>
            </div>
          </div>
        `).join('');
      } catch (error) {
        commentsList.innerHTML = '<p class="no-comments">Failed to load comments</p>';
      }
    }

    // Modal Handlers
    const modals = ['createPostModal', 'editPostModal', 'commentModal'];
    modals.forEach(modalId => {
      const modal = document.getElementById(modalId);
      const closeBtn = modal.querySelector('.btn-close, #closeCreatePostModal, #closeEditPostModal, #closeCommentModal');
      const backdrop = modal.querySelector('.modal-backdrop');
      
      if (closeBtn) closeBtn.addEventListener('click', () => modal.classList.remove('show'));
      if (backdrop) backdrop.addEventListener('click', () => modal.classList.remove('show'));
    });

    document.getElementById('openCreatePostModal')?.addEventListener('click', () => {
      document.getElementById('createPostModal').classList.add('show');
    });

    document.getElementById('cancelCreatePost')?.addEventListener('click', () => {
      document.getElementById('createPostModal').classList.remove('show');
    });

    document.getElementById('cancelEditPost')?.addEventListener('click', () => {
      document.getElementById('editPostModal').classList.remove('show');
    });

    // Form Submissions
    document.getElementById('createPostForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      try {
        const response = await fetch("{% url 'forumModule:create_post' %}", {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
          },
          body: formData,
        });

        if (response.ok) {
          document.getElementById('createPostModal').classList.remove('show');
          e.target.reset();
          loadPosts();
        }
      } catch (error) {
        console.error("Error:", error);
      }
    });

    document.getElementById('editPostForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const postId = formData.get("post_id");

      try {
        const response = await fetch(`/forum/edit/${postId}/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
          },
          body: formData,
        });

        if (response.ok) {
          document.getElementById('editPostModal').classList.remove('show');
          loadPosts();
        }
      } catch (error) {
        console.error("Error:", error);
      }
    });

    document.getElementById('commentForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const postId = document.getElementById('commentPostId').value;
      const content = document.getElementById('commentContent').value.trim();

      if (!content) return;

      try {
        const response = await fetch(`/forum/comment/${postId}/add/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: `content=${encodeURIComponent(content)}`,
        });

        if (response.ok) {
          document.getElementById('commentContent').value = "";
          await loadComments(postId);
        }
      } catch (error) {
        console.error("Error:", error);
      }
    });

    // Filter Tabs
    filterAllBtn.addEventListener('click', () => {
      filterAllBtn.classList.add('active');
      filterMyBtn?.classList.remove('active');
      loadPosts("all");
    });

    filterMyBtn?.addEventListener('click', () => {
      filterMyBtn.classList.add('active');
      filterAllBtn.classList.remove('active');
      loadPosts("my");
    });

    // Initial Load
    loadPosts();
  });
</script>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

    min-height: 100vh;
  }

  .forum-wrapper {
    min-height: 100vh;
    padding: 5rem 1rem 2rem 1rem;
  }

  .forum-container {
    max-width: 680px;
    margin: 0 auto;
  }

  .forum-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 0 0.5rem;
  }

  .forum-title {
    font-size: 3rem;
    font-weight: 800;
    background: linear-gradient(135deg, #4338ca 0%, #6b21a8 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .forum-subtitle {
    color: rgba(255, 255, 255, 0.8);
    margin-top: 0.25rem;
  }

  .btn-create {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, #4338ca 0%, #6b21a8 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  }

  .btn-create:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
  }

  .filter-tabs {
    display: flex;
    gap: 0.5rem;
    background: white;
    backdrop-filter: blur(10px);
    padding: 0.5rem;
    border-radius: 16px;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .tab {
    flex: 1;
    padding: 0.75rem 1.5rem;
    border: none;
    background: transparent;
    color: #718096;
    font-weight: 600;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s;
  }

  .tab.active {
    background: linear-gradient(135deg, #4338ca 0%, #6b21a8 100%);
    color: white ;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); 
  }

  .posts-feed {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .post-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    display: flex;
    gap: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s;
  }

  .post-card:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
  }

  .post-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    background: linear-gradient(135deg, #4338ca 0%, #6b21a8 100%);
  }

  .post-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .post-content {
    flex: 1;
    min-width: 0;
  }

  .post-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
  }

  .post-author {
    font-weight: 700;
    color: #1a202c;
  }

  .post-meta {
    color: #718096;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .category-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.75rem;
  }

  .post-description {
    color: #2d3748;
    line-height: 1.6;
    margin-bottom: 1rem;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .post-image {
    width: 100%;
    border-radius: 12px;
    margin-bottom: 1rem;
    max-height: 400px;
    object-fit: cover;
  }

  .post-actions {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid #e2e8f0;
  }

  .action-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    background: none;
    border: none;
    color: #718096;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.2s;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .action-btn:hover {
    background: #f7fafc;
    color: #4338ca;
  }

  .action-btn.liked {
    color: #e53e3e;
  }

  .action-btn.liked svg {
    fill: #e53e3e;
  }

  .action-btn.views {
    cursor: default;
  }

  .action-btn.views:hover {
    background: transparent;
    color: #718096;
  }

  .action-btn.edit:hover {
    color: #ed8936;
  }

  .action-btn.delete:hover {
    color: #e53e3e;
  }

  .action-btn svg {
    width: 20px;
    height: 20px;
  }

  /* Modal Styles */
  .modal {
    position: fixed;
    inset: 0;
    z-index: 1000; 
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .modal.show {
    display: flex;
  }

  .modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);  
    -webkit-backdrop-filter: blur(4px); 
    z-index: 1; 
  }

  .modal-content {
    position: relative;
    z-index: 2;  
    background: white;
    border-radius: 20px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideUp 0.3s ease-out;
  }

  @keyframes modalSlideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid #e2e8f0;
  }

  .modal-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, #4338ca 0%, #6b21a8 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .btn-close {
    background: none;
    border: none;
    color: #718096;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: all 0.2s;
  }

  .btn-close:hover {
    background: #f7fafc;
    color: #2d3748;
  }

  .modal-form {
    padding: 1.5rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.5rem;
  }

  .form-group label span {
    color: #a0aec0;
    font-weight: 400;
    font-size: 0.875rem;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-family: inherit;
    font-size: 1rem;
    transition: all 0.2s;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #4338ca;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }

  .modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
  }

  .btn-primary {
    background: linear-gradient(135deg, #4338ca 0%, #6b21a8 100%);
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }

  .btn-secondary {
    background: #f7fafc;
    color: #4a5568;
    border: 2px solid #e2e8f0;
    padding: 0.75rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-secondary:hover {
    background: #edf2f7;
  }

  /* Comments */
  .comments-list {
    padding: 1.5rem;
    max-height: 400px;
    overflow-y: auto;
  }

  .comment-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    border-radius: 12px;
    transition: background 0.2s;
  }

  .comment-item:hover {
    background: #f7fafc;
  }

  .comment-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4338ca 0%, #6b21a8 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    flex-shrink: 0;
  }

  .comment-content {
    flex: 1;
  }

  .comment-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .comment-author {
    font-weight: 700;
    color: #2d3748;
  }

  .comment-time {
    color: #a0aec0;
    font-size: 0.875rem;
  }

  .comment-content p {
    color: #4a5568;
    line-height: 1.5;
  }

  .comment-form {
    padding: 1.5rem;
    border-top: 1px solid #e2e8f0;
  }

  .comment-form textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-family: inherit;
    margin-bottom: 1rem;
    resize: vertical;
  }

  .comment-form textarea:focus {
    outline: none;
    border-color: #4338ca;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .no-comments,
  .login-prompt {
    text-align: center;
    color: #a0aec0;
    padding: 2rem;
  }

  /* Loading States */
  .loading-state,
  .empty-state,
  .error-state {
    text-align: center;
    padding: 3rem 1rem;
    color: rgba(255, 255, 255, 0.8);
  }

  .spinner {
    width: 48px;
    height: 48px;
    border: 4px solid rgba(255, 255, 255, 0.2);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  .spinner-sm {
    width: 24px;
    height: 24px;
    border: 3px solid rgba(102, 126, 234, 0.2);
    border-top-color: #4338ca;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .loading-comments {
    padding: 2rem;
    display: flex;
    justify-content: center;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .forum-wrapper {
      padding: 1rem 0.5rem;
    }

    .forum-header {
      flex-direction: row; 
      justify-content: space-between;  
      align-items: center; 
      gap: 1rem; 
      text-align: left; 
    }

    .forum-title {
      font-size: 1.5rem;
    }

    .btn-create {
      width: auto; 
      padding: 0.5rem 1rem;  
      font-size: 0.875rem; 
    }
  }
</style>
{% endblock content %}