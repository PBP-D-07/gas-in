{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="bg-gray-100 w-full min-h-screen pt-16">
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Navigation -->
        <div class="mb-4 flex items-center justify-between">
            <a href="{% url 'forumModule:show_main' %}" class="text-gray-600 hover:text-gray-900 font-medium transition-colors flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to Homepage
            </a>
        </div>

        <!-- Post Card -->
        <article id="post-detail" class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
            <div class="p-4 sm:p-6">
                <div id="post-meta" class="flex flex-wrap items-center gap-2 mb-3">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-500 text-white">
                        Loading...
                    </span>
                </div>

                <div id="post-thumbnail-container" class="mb-4">
                </div>

                <div id="post-content" class="text-gray-800 leading-relaxed whitespace-pre-line text-base mb-4">
                    Loading...
                </div>

                <div id="post-meta-details" class="flex flex-wrap items-center text-xs text-gray-500 gap-3 mb-4">
                    <span>Loading...</span>
                </div>

                <!-- Action Bar (Like & Comment) -->
                <div class="border-t border-gray-200 pt-3 mb-4">
                    <div class="flex items-center gap-6 text-gray-600">
                        <button id="like-button" onclick="toggleLike()" class="flex items-center gap-1 hover:text-pink-600">
                            <span id="like-icon">ü§ç</span>
                            <span id="like-count">0</span>
                        </button>
                        <div class="flex items-center gap-1">
                            <span>üí¨</span>
                            <span id="comment-count">0</span>
                        </div>
                    </div>
                </div>

                <!-- Footer (Author + Action) -->
                <div id="post-footer" class="border-t border-gray-200 pt-4 flex items-center justify-between text-gray-700 text-sm">
                    <p id="post-author" class="font-medium">Author: Loading...</p>

                    {% if user.is_authenticated and is_owner %}
                    <div class="flex gap-2">
                        <button id="openEditModal" 
                            class="px-3 py-1 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600 transition-colors">
                            Edit
                        </button>
                        <form action="{% url 'forumModule:delete_post' post.id %}" method="POST" 
                              onsubmit="return confirm('Are you sure you want to delete this post?');" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" 
                                    class="px-3 py-1 bg-red-500 text-white text-sm rounded-md hover:bg-red-600 transition-colors">
                                Delete
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </article>

        <!-- Comment Section -->
        <div class="bg-white rounded-lg border border-gray-200 shadow-sm mt-4 overflow-hidden">
            {% if user.is_authenticated %}
            <div class="p-4 border-b border-gray-200">
                <form id="comment-form">
                    {% csrf_token %}
                    <textarea id="comment-input" placeholder="Write a comment..." rows="2" class="w-full border rounded-lg px-3 py-2 mb-2"></textarea>
                    <button id="comment-submit-btn" type="submit" class="px-4 py-2 bg-blue-500 text-white text-sm rounded-md hover:bg-blue-600">Comment</button>
                </form>
            </div>
            {% else %}
            <div class="p-4 border-b bg-gray-50 text-center text-gray-600">
                Please login to comment
            </div>
            {% endif %}
            
            <div id="comments-container" class="divide-y">
                <p class="p-4 text-center text-gray-500 text-sm">Loading comments...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Edit -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 relative">
        <button id="closeEditModal" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">&times;</button>
        <h2 class="text-lg font-semibold mb-4">Edit Post</h2>

        <form id="editForm" class="flex flex-col gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">Category</label>
                <input type="text" id="editCategory" name="category" class="w-full border rounded-lg p-2">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="editDescription" name="description" class="w-full border rounded-lg p-2 h-24"></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">Thumbnail URL</label>
                <input type="url" id="editThumbnail" name="thumbnail" placeholder="https://example.com/image.jpg"
                       class="w-full border rounded-lg p-2">
              </div>              
        
            <div class="flex justify-end gap-2">
                <button type="button" id="cancelEdit" class="px-4 py-2 text-gray-600 border rounded-md hover:bg-gray-100">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
const postId = "{{ post_id }}";
const isAuthenticated = "{{ user.is_authenticated }}" === "True";
const currentUsername = "{{ user.username }}";

// Helper function
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === name + "=") {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// Toggle Like
window.toggleLike = async function() {
  if (!isAuthenticated) {
    alert("Please login to like posts!");
    return;
  }

  try {
    const response = await fetch(`/forum/like/${postId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie('csrftoken'),
        "X-Requested-With": "XMLHttpRequest",
      },
    });
    
    if (response.ok) {
      const data = await response.json();
      document.getElementById('like-count').textContent = data.like_count;
      document.getElementById('like-icon').textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
    }
  } catch (error) {
    console.error("Error:", error);
  }
};

// RENDER HELPERS
function renderCommentsToContainer(comments) {
  const container = document.getElementById('comments-container');
  document.getElementById('comment-count').textContent = comments.length;
  if (!comments || comments.length === 0) {
    container.innerHTML = '<p class="p-4 text-center text-gray-500 text-sm">No comments yet</p>';
    return;
  }
  container.innerHTML = comments.map(c => {
    const isYou = c.user === currentUsername;
    const date = new Date(c.created_at).toLocaleString();
    return `
      <div class="p-4">
        <p class="font-semibold text-sm">${c.user}${isYou ? " (You)" : ""}</p>
        <p class="text-gray-700 text-sm mt-1">${c.content}</p>
        <p class="text-xs text-gray-500 mt-1">${date}</p>
      </div>
    `;
  }).join('');
}

async function loadCommentsFromDB() {
  try {
    const response = await fetch(`/forum/comment/${postId}/`);
    if (!response.ok) {
      return [];
    }
    const comments = await response.json();
    return comments || [];
  } catch (err) {
    console.warn("Failed to fetch DB comments:", err);
    return [];
  }
}

document.addEventListener("DOMContentLoaded", async () => {
  const url = `/forum/json/${postId}/`;
  let isDummy = false; // true jika post berasal dari forum.json (file)
  let fileComments = [];
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error("Post not found");
    const data = await response.json();

    document.getElementById("post-meta").innerHTML = `
      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-500 text-white">
        ${data.category ? data.category.toUpperCase() : "Uncategorized"}
      </span>
      ${data.is_hot ? '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">üî• Hot</span>' : ''}
    `;

    document.getElementById("post-meta-details").innerHTML = `
      <time datetime="${new Date(data.created_at).toISOString()}">
        ${new Date(data.created_at).toLocaleString('en-US', { 
          month: 'short', day: 'numeric', year: 'numeric', 
          hour: 'numeric', minute: '2-digit', hour12: true 
        })}
      </time>
      <span>${data.post_views || 0} views</span>
    `;

    document.getElementById("post-content").textContent = data.description || "(No content)";

    // like count
    document.getElementById('like-count').textContent = data.like_count || 0;

    const thumbContainer = document.getElementById("post-thumbnail-container");
    if (data.thumbnail) {
    thumbContainer.innerHTML = `
        <img src="${data.thumbnail}" 
            class="w-full h-64 sm:h-80 object-cover rounded-lg" 
            alt="${data.category || 'Post image'}"
            onerror="this.parentElement.innerHTML=''">
    `;
    } else {
    thumbContainer.innerHTML = ''; 
    }

    document.getElementById("post-author").innerHTML = `<p class="font-medium">Author: ${data.owner_username || "Anonymous"}</p>`;

    if (Array.isArray(data.comments)) {
      isDummy = true;
      fileComments = data.comments;
    }

    if (isDummy) {
      const commentFormDiv = document.getElementById('comment-input')?.closest('form');
      if (commentFormDiv) {
        commentFormDiv.querySelector('textarea').setAttribute('disabled', 'disabled');
        const btn = commentFormDiv.querySelector('button[type="submit"]');
        if (btn) {
          btn.setAttribute('disabled', 'disabled');
          btn.textContent = 'Comment (read-only)';
        }
      }
      renderCommentsToContainer(fileComments);
    } else {
      const dbComments = await loadCommentsFromDB();
      renderCommentsToContainer(dbComments);
    }

    // Modal handling (edit)
    const modal = document.getElementById("editModal");
    const openModal = document.getElementById("openEditModal");
    const closeModal = document.getElementById("closeEditModal");
    const cancelEdit = document.getElementById("cancelEdit");
    const form = document.getElementById("editForm");

    if (openModal && closeModal && cancelEdit && form) {
      openModal.addEventListener("click", () => {
          modal.classList.remove("hidden");
          modal.classList.add("flex");
          document.getElementById("editCategory").value = data.category || "";
          document.getElementById("editDescription").value = data.description || "";
          document.getElementById("editThumbnail").value = data.thumbnail || "";
      });

      const close = () => modal.classList.add("hidden");
      closeModal.addEventListener("click", close);
      cancelEdit.addEventListener("click", close);

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const csrfToken = "{{ csrf_token }}";

        const res = await fetch(`/forum/edit/${postId}/`, {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken, "X-Requested-With": "XMLHttpRequest" },
          body: formData,
        });

        const result = await res.json();
        if (res.ok) {
          alert("Post updated successfully!");
          location.reload();
        } else {
          alert("Error: " + JSON.stringify(result.error));
        }
      });
    }

  } catch (err) {
    document.getElementById("post-detail").innerHTML = `
      <div class="p-4 sm:p-6 text-center text-red-600 font-medium">
        Error loading post: ${err.message}
      </div>`;
  }

  const commentForm = document.getElementById('comment-form');
  if (commentForm) {
    commentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const textarea = document.getElementById('comment-input');
      if (!textarea || textarea.disabled) return;

      const content = textarea.value.trim();
      if (!content) return alert("Comment cannot be empty!");

      try {
        const response = await fetch(`/forum/comment/${postId}/add/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie('csrftoken'),
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: `content=${encodeURIComponent(content)}`,
        });

        if (response.ok) {
          textarea.value = "";
          const dbComments = await loadCommentsFromDB();
          renderCommentsToContainer(dbComments);
        } else {
          const err = await response.json().catch(()=>({error:'Unknown'}));
          alert("Failed to send comment: " + (err.error || JSON.stringify(err)));
        }
      } catch (error) {
        console.error("Error adding comment:", error);
      }
    });
  }
});
</script>

{% endblock content %}
