{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>gas.in</title>
{% endblock meta %}

{% block content %}

<div class="min-h-screen">
  <!-- Hero / Landing -->
  <section class="w-full bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 text-white py-20">
    <div class="mx-auto px-4 text-center">
      <h1 class="text-5xl font-extrabold mb-4">Temukan Tempat Olahraga Terbaik</h1>
      <p class="text-xl opacity-90 mb-8">Cari dan pesan venue olahraga di sekitarmu â€” lari, futsal, badminton, dan lainnya.</p>
      <div class="flex items-center justify-center gap-4">
        <a id="cta-view" href="#grid" class="inline-block bg-white text-blue-700 font-semibold px-6 py-3 rounded shadow hover:-translate-y-1 transition-transform">Lihat Semua Venue</a>
        {% if user.is_authenticated %}
        <a href="{% url 'venue:add_venue_entry_ajax' %}" class="inline-block bg-white/20 border border-white text-white px-5 py-3 rounded hover:bg-white/30">Tambah Venue</a>
        {% else %}
        <a href="{% url 'main:show_login' %}" class="inline-block bg-white/20 border border-white text-white px-5 py-3 rounded hover:bg-white/30">Masuk untuk Menambah</a>
        {% endif %}
      </div>
    </div>
  </section>

  <!-- Loading State -->
  <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
    <svg class="animate-spin h-8 w-8 text-blue-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-gray-600 mt-3">Loading venues...</p>
  </div>

  <!-- Error State -->
  <div id="error" class="hidden my-4"></div>

  <!-- Product Grid -->
  <div id="grid" class="hidden mt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>

  <div class="mt-6 text-center">
      <a href="{% url 'main:show_main' %}" class="inline-flex items-center gap-2 bg-white text-blue-700 font-semibold px-4 py-2 rounded shadow hover:bg-gray-100 transition-colors">
        <span>Kembali ke Beranda</span>
      </a>
  </div>
</div>

<script>
// Configuration
const VENUE_API_ENDPOINT = "{% url 'venue:show_json_venue' %}";
const CURRENT_USER_ID = String({{ user.id|default_if_none:'null' }} || '');

// DOM elements
const loadingSpinner = document.getElementById('loading');
const errorMessage = document.getElementById('error');
const venueGridContainer = document.getElementById('grid');

// Show/hide page sections
function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
  loadingSpinner.classList.toggle('hidden', !showLoading);
  errorMessage.classList.toggle('hidden', !showError);
  venueGridContainer.classList.toggle('hidden', !showGrid);
  
  // Add container + grid classes when showing grid so spacing and max width are preserved
  if (showGrid) {
    venueGridContainer.className = 'mx-auto p-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6';
  }
}

// Get readable category name
function getReadableCategoryName(categoryCode) {
  const categoryMapping = {
    running: 'Lari',
    badminton: 'Badminton',
    futsal: 'Futsal',
    football: 'Sepak Bola',
    basketball: 'Basket',
    cycling: 'Sepeda',
    volleyball: 'Voli',
    yoga: 'Yoga',
    padel: 'Padel',
    other: 'Lainnya',
  };
  return categoryMapping[categoryCode] || categoryCode;
}

// Create venue card element
function buildVenueCardElement(item) {
    const article = document.createElement('article');
    article.className = 'bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full';

  const linkDetail = `{% url 'venue:venue_detail' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);

    const name = DOMPurify.sanitize(item.name);
    const description = DOMPurify.sanitize(item.description);
    const location = DOMPurify.sanitize(item.location);
    const thumbnail = DOMPurify.sanitize(item.thumbnail);
    const category = DOMPurify.sanitize(item.category);
    const contactNumber = DOMPurify.sanitize(item.contact_number);
    const owner = DOMPurify.sanitize(item.owner);
    const createdAt = DOMPurify.sanitize(new Date(item.created_at).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    }));
    const thumbnailHtml = DOMPurify.sanitize(
        item.thumbnail ? `<img src='${thumbnail}' alt='${name}' class='w-full h-full object-cover'>` : `<div class='w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center'></div>`
    );
    const categoryLabel = DOMPurify.sanitize(getReadableCategoryName(category));

    const cardHtml = `
        <div class="aspect-[16/9] overflow-hidden">
          ${thumbnailHtml}
        </div>
        <div class="p-5 flex flex-col flex-1">
          <div class="mb-2">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-blue-600 text-white">${categoryLabel}</span>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-3 line-clamp-2 leading-tight">
            <a href="${linkDetail}" class="hover:text-green-600 transition-colors">${name}</a>
          </h3>
          <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-4">${location}</p>
          <div class="pt-4 border-t border-gray-100 flex items-center justify-between mt-auto">
            <a href="${linkDetail}" class="text-blue-600 hover:text-blue-700 font-medium text-sm transition-colors">Read more</a>
          </div>
        </div>
    `;
    
    article.innerHTML = cardHtml;
    return article;
}

// Render all venue cards
function renderAllVenueCards(venueItems) {
  venueGridContainer.innerHTML = '';
  venueItems.forEach(venueItem => {
    const cardElement = buildVenueCardElement(venueItem);
    venueGridContainer.appendChild(cardElement);
  });
}

// Fetch venue data from server
async function fetchVenuesFromServer() {
  try {
    displayPageSection({ showLoading: true });

    const response = await fetch(VENUE_API_ENDPOINT, {
      headers: { 'Accept': 'application/json' },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch venue data from server');
    }

  const venueData = await response.json();
  // Render all received venues directly
  renderAllVenueCards(venueData || []);
  displayPageSection({ showGrid: true });
  } catch (error) {
    console.error('Error loading venues:', error);
    displayPageSection({ showError: true });
  }
}

// Initialize page
function initializeVenuePage() {
  fetchVenuesFromServer();
}

// Start application
initializeVenuePage();

// Add event listener to detect new venues
document.addEventListener('venueAdded', function() {
    // Refresh venue data without page reload
    fetchVenuesFromServer();
});

</script>

{% endblock content %}