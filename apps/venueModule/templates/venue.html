{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>gas.in</title>
{% endblock meta %}

{% block content %}

<div class="pt-16">
  <!-- Hero / Landing (full viewport minus navbar) -->
  <section class="w-full bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 text-white flex items-center justify-center" style="min-height: calc(100vh - 4rem);">
    <div class="mx-auto px-4 w-full max-w-4xl flex flex-col items-center justify-center text-center">
      <h1 class="text-5xl font-extrabold mb-4">Found The Best Sports Venues In Your Area with gas.in!</h1>
      <p class="text-xl opacity-90 mb-8 max-w-2xl">Find and book sports venues near you, such as running, futsal, badminton, and a lot more venue options.</p>
      <div class="flex items-center justify-center gap-4">
        <a id="cta-view" href="#grid" class="inline-block bg-white text-blue-700 font-semibold px-6 py-3 rounded shadow hover:-translate-y-1 transition-transform">Get Started!</a>
        {% comment %} {% if user.is_authenticated %}
        <a href="{% url 'venue:add_venue_entry_ajax' %}" class="inline-block bg-white/20 border border-white text-white px-5 py-3 rounded hover:bg-white/30">Tambah Venue</a>
        {% else %}
        <a href="{% url 'main:show_login' %}" class="inline-block bg-white/20 border border-white text-white px-5 py-3 rounded hover:bg-white/30">Masuk untuk Menambah</a>
        {% endif %} {% endcomment %}
      </div>
    </div>
  </section>

  <!-- Loading State -->
  <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
    <svg class="animate-spin h-8 w-8 text-blue-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-gray-600 mt-3">Loading venues...</p>
  </div>

  <!-- Error State -->
  <div id="error" class="hidden my-4"></div>

  <!-- Empty State -->
  <div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden m-4">
    <div class="w-32 h-32 mx-auto mb-4">
      <img src="{% static 'image/no-image.jpg' %}" alt="No venue available" class="w-full h-full object-contain">
    </div>
    <h3 class="text-lg font-medium text-gray-900 mb-2">No Venue Available</h3>
    <p class="text-gray-500 mb-6">Stay tuned for more venues updates.</p>
  </div>

  <!-- Product Grid -->
  <div id="grid" class="hidden mt-6 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-10" style="scroll-margin-top: 6rem;"></div>

  <div class="py-6 text-center">
      <a href="{% url 'main:show_main' %}" class="inline-flex items-center gap-2 bg-white text-blue-700 font-semibold px-4 py-2 rounded shadow hover:bg-gray-100 transition-colors">
        <span>Kembali ke Beranda</span>
      </a>
  </div>
</div>

<script>
// Configuration
const VENUE_API_ENDPOINT = "{% url 'venue:show_json_venue' %}";
const CURRENT_USER_ID = String({{ user.id|default_if_none:'null' }} || '');

// DOM elements
const loadingSpinner = document.getElementById('loading');
const errorMessage = document.getElementById('error');
const emptyState = document.getElementById('empty');
const venueGridContainer = document.getElementById('grid');

// Show/hide page sections
function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
  loadingSpinner.classList.toggle('hidden', !showLoading);
  errorMessage.classList.toggle('hidden', !showError);
  emptyState.classList.toggle('hidden', !showEmpty);
  venueGridContainer.classList.toggle('hidden', !showGrid);
  
  // Add container + grid classes when showing grid so spacing and max width are preserved
  if (showGrid) {
    venueGridContainer.className = 'mx-auto p-4 mt-8 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-10';
  }
}

// Get readable category name
function getReadableCategoryName(categoryCode) {
  const categoryMapping = {
    running: 'Lari',
    badminton: 'Badminton',
    futsal: 'Futsal',
    football: 'Sepak Bola',
    basketball: 'Basket',
    cycling: 'Sepeda',
    volleyball: 'Voli',
    yoga: 'Yoga',
    padel: 'Padel',
    other: 'Lainnya',
  };
  return categoryMapping[categoryCode] || categoryCode;
}

// Create venue card element
function buildVenueCardElement(item) {
    const article = document.createElement('article');
    article.className = 'bg-white rounded-lg border border-gray-200 hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full';

  const linkDetail = `{% url 'venue:venue_detail' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);

    const name = DOMPurify.sanitize(item.name);
    const description = DOMPurify.sanitize(item.description);
    const location = DOMPurify.sanitize(item.location);
    const thumbnail = DOMPurify.sanitize(item.thumbnail);
    const category = DOMPurify.sanitize(item.category);
    const contactNumber = DOMPurify.sanitize(item.contact_number);
    const owner = DOMPurify.sanitize(item.owner);
    const createdAt = DOMPurify.sanitize(new Date(item.created_at).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric' 
    }));
    const thumbnailHtml = DOMPurify.sanitize(
        item.thumbnail ? `<img src='${thumbnail}' alt='${name}' class='w-full h-full object-cover'>` : `<div class='w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center'></div>`
    );
    const categoryLabel = DOMPurify.sanitize(getReadableCategoryName(category));

    const cardHtml = `
        <div class="aspect-square overflow-hidden">
          <a href="${linkDetail}">
          ${thumbnailHtml}
          </a>
        </div>
        <div class="p-4 flex flex-col flex-1">
          <div class="mb-2">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-blue-100 text-blue-600">${categoryLabel}</span>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 mb-3 line-clamp-2 leading-tight">
            <a href="${linkDetail}" class="hover:text-blue-600 transition-colors">${name}</a>
          </h3>
          <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-3">${location}</p>
          <div class="pt-3 border-t border-gray-100 flex items-center justify-between mt-auto">
            <a href="${linkDetail}" class="text-blue-600 hover:text-blue-700 font-medium text-sm transition-colors">View</a>
          </div>
        </div>
    `;
    
    article.innerHTML = cardHtml;
    return article;
}

// Render all venue cards
function renderAllVenueCards(venueItems) {
  venueGridContainer.innerHTML = '';
  venueItems.forEach(venueItem => {
    const cardElement = buildVenueCardElement(venueItem);
    venueGridContainer.appendChild(cardElement);
  });
}

// Fetch venue data from server
async function fetchVenuesFromServer() {
  try {
    displayPageSection({ showLoading: true });

    const response = await fetch(VENUE_API_ENDPOINT, {
      headers: { 'Accept': 'application/json' },
    });

    // Handle non-2xx responses and show an error message
    if (!response.ok) {
      let serverText = '';
      try {
        const jsonErr = await response.json();
        serverText = jsonErr.detail || JSON.stringify(jsonErr);
      } catch (e) {
        serverText = await response.text();
      }
      const statusText = response.status ? ` (${response.status} ${response.statusText || ''})` : '';
      errorMessage.innerText = `Gagal memuat data venue${statusText}. ${serverText}`;
      displayPageSection({ showError: true });
      return;
    }

    const venueData = await response.json();

    // If no venues returned, show empty state
    if (!venueData || (Array.isArray(venueData) && venueData.length === 0)) {
      venueGridContainer.innerHTML = '';
      displayPageSection({ showEmpty: true });
    } else {
      // Render all received venues directly
      renderAllVenueCards(venueData || []);
      displayPageSection({ showGrid: true });
    }
  } catch (error) {
    console.error('Error loading venues:', error);
    displayPageSection({ showError: true });
  }
}

// Initialize page
function initializeVenuePage() {
  fetchVenuesFromServer();
}

// Start application
initializeVenuePage();

// Add event listener to detect new venues
document.addEventListener('venueAdded', function() {
    // Refresh venue data without page reload
    fetchVenuesFromServer();
});

</script>

{% endblock content %}