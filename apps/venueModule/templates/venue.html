{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>gas.in</title>
{% endblock meta %}

{% block content %}

<div class="flex flex-col items-center pt-20 min-h-screen">
    <p>Welcome to the venue page!</p>
    <p>Pick your favorite venue!!!</p>
    <div class="mt-4">
        <a href="{% url 'main:show_main' %}" class="text-blue-500 hover:underline">Back to Home</a>
    </div>

    <!-- Loading State -->
    <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <svg class="animate-spin h-8 w-8 text-blue-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3">Loading products...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden"></div>

    <!-- Product Grid -->
  <div id="venue-count" class="text-sm text-gray-700 mt-4"></div>
  <pre id="venue-debug-list" class="mt-2 text-xs text-gray-800 bg-gray-50 p-2 rounded max-w-3xl whitespace-pre-wrap"></pre>
  <div id="grid" class="hidden"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
<script>

// Configuration
const VENUE_API_ENDPOINT = "{% url 'venue:show_json_venue' %}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

// DOM Elements
const loadingSpinner = document.getElementById('loading');
const errorMessage = document.getElementById('error');
const eventGridContainer = document.getElementById('grid');

let allVenuesData = [];

// Show/hide page sections
function displayPageSection({ showLoading = false, showError = false, showGrid = false, emptyMessage = '' }) {
  loadingSpinner.classList.toggle('hidden', !showLoading);
  errorMessage.classList.toggle('hidden', !showError);
  eventGridContainer.classList.toggle('hidden', !showGrid);

  if (showGrid) {
    eventGridContainer.className = 'grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4';
  }

  if (showError && emptyMessage) {
    errorMessage.innerHTML = `<div class="bg-red-50 border border-red-100 text-red-700 p-4 rounded">${DOMPurify.sanitize(emptyMessage)}</div>`;
  }
}

// Map category codes to readable names (from models)
function getReadableCategoryName(categoryCode) {
  const mapping = {
    'concert': 'Concert',
    'sports': 'Sports',
    'theater': 'Theater',
    'conference': 'Conference',
    'exhibition': 'Exhibition',
    'other': 'Other',
  };
  return mapping[categoryCode] || categoryCode || 'Other';
}

// Build a Venue card element
function buildVenueCardElement(item) {
  const article = document.createElement('article');
  article.className = 'bg-white rounded-lg border-2 border-gray-300 hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full';

  // Use the venue detail URL pattern and replace a placeholder UUID
  const linkDetail = `{% url 'venue:venue_detail' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);

  const name = DOMPurify.sanitize(item.name || '');
  const description = DOMPurify.sanitize(item.description || '');
  const location = DOMPurify.sanitize(item.location || '');
  const category = DOMPurify.sanitize(item.category || 'other');
  const thumbnail = DOMPurify.sanitize(item.thumbnail || '');
  const createdAt = item.created_at ? new Date(item.created_at) : null;
  const createdLabel = createdAt ? DOMPurify.sanitize(createdAt.toLocaleString('id-ID')) : '';
  const isAccepted = item.is_accepted;
  const ownerId = item.owner_id ? String(item.owner_id) : '';

  const thumbnailHtml = DOMPurify.sanitize(
    item.thumbnail ? `<img src='${thumbnail}' alt='${name}' class='w-full h-full object-cover'>` : `<div class='w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center'><span class='text-gray-500'>No image</span></div>`
  );

  const categoryLabel = getReadableCategoryName(category);
  const acceptedLabel = isAccepted ? `<span class='inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium bg-green-100 text-green-800'>Accepted</span>` : `<span class='inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium bg-yellow-100 text-yellow-800'>Pending</span>`;

  const ownerActions = (CURRENT_USER_ID && ownerId && CURRENT_USER_ID === ownerId)
    ? `<div class='flex space-x-2'>
         <button onclick="editVenue('${item.id}')" class='text-gray-600 hover:text-gray-700 text-sm'>Edit</button>
         <button onclick="confirmDeleteVenue('${item.id}', '${name.replace(/'/g, "\\'") }')" class='text-red-600 hover:text-red-700 text-sm'>Delete</button>
       </div>`
    : '';

  const cardHtml = `
    <div class="aspect-square relative overflow-hidden">
      <a href="${linkDetail}" class="block w-full h-full hover:opacity-90 transition-opacity">
        ${thumbnailHtml}
      </a>
    </div>
    <div class="p-4 flex flex-col flex-1">
      <div class="flex items-center gap-2 mb-3">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-blue-600 text-white">${categoryLabel}</span>
        ${acceptedLabel}
      </div>
      <h3 class="text-lg font-semibold text-gray-900 mb-3 line-clamp-2 leading-tight">
        <a href="${linkDetail}" class="hover:text-blue-600 transition-colors text-3xl">${name}</a>
      </h3>
      <p class="text-sm text-gray-600 mb-3 line-clamp-3">${description}</p>
      <div class="text-sm text-gray-500 mb-3">Location: ${location}</div>
      <div class="text-xs text-gray-400 mb-3">Created: ${createdLabel}</div>
      <div class="pt-4 border-t border-gray-200 flex items-center justify-between mt-auto">
        <a href="${linkDetail}" class="text-blue-600 hover:text-green-700 font-medium text-sm transition-colors">View</a>
        ${ownerActions}
      </div>
    </div>
  `;

  article.innerHTML = cardHtml;
  return article;
}

// Render grid with data
function renderGrid(data) {
  eventGridContainer.innerHTML = '';
  if (!data || data.length === 0) {
    displayPageSection({ showLoading: false, showError: true, showGrid: false, emptyMessage: 'No venues found.' });
    return;
  }
  console.log('[venue] renderGrid: rendering', data.length, 'items');
  // show count for quick visibility
  const venueCountEl = document.getElementById('venue-count');
  if (venueCountEl) venueCountEl.textContent = `Found ${data.length} venues`;

  data.forEach(item => {
    try {
      const el = buildVenueCardElement(item);
      eventGridContainer.appendChild(el);
    } catch (e) {
      console.error('[venue] renderGrid: error building card for item', item, e);
    }
  });
  // populate debug list (plain text) so we can see data regardless of card layout
  try {
    const dbg = document.getElementById('venue-debug-list');
    if (dbg) {
      const names = data.slice(0, 20).map((it, idx) => `${idx+1}. ${it.name || '[no name]'} (${it.id})`).join('\n');
      dbg.innerText = `First ${Math.min(20, data.length)} venues:\n` + names;
    }
  } catch (e) {
    console.error('[venue] renderGrid: failed to populate debug list', e);
  }
  // Ensure grid is visible
  displayPageSection({ showLoading: false, showError: false, showGrid: true });
  eventGridContainer.classList.remove('hidden');
}

// Fetch venues from API
async function fetchVenues() {
  try {
    console.log('[venue] fetchVenues: fetching', VENUE_API_ENDPOINT);
    displayPageSection({ showLoading: true, showError: false, showGrid: false });
    const resp = await fetch(VENUE_API_ENDPOINT, { credentials: 'same-origin' });
    if (!resp.ok) throw new Error('Server returned ' + resp.status);
    const data = await resp.json();
    console.log('[venue] fetchVenues: received', Array.isArray(data) ? data.length : 'non-array', 'items');
    allVenuesData = data;
    renderGrid(allVenuesData);
  } catch (err) {
    console.error('Failed to load venues', err);
    displayPageSection({ showLoading: false, showError: true, showGrid: false, emptyMessage: 'Failed to load venues.' });
  }
}

// Small stubs for edit/delete actions if user wants to implement later
function editVenue(id) {
  // placeholder: open edit page or show modal
  window.location.href = `{% url 'venue:venue_detail' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id) + 'edit/';
}

function confirmDeleteVenue(id, name) {
  if (!confirm(`Delete venue "${name}"?`)) return;
  // send DELETE via fetch to app endpoint (not implemented)
  alert('Delete not implemented in this demo.');
}

document.addEventListener('DOMContentLoaded', () => {
  fetchVenues();
});

{% endblock content %}