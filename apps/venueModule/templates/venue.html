{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>gas.in</title>
{% endblock meta %}

{% block content %}

<div class="flex flex-col items-center pt-20 min-h-screen">
    <p>Welcome to the venue page!</p>
    <p>Pick your favorite venue!!!</p>
    <div class="mt-4">
        <a href="{% url 'main:show_main' %}" class="text-blue-500 hover:underline">Back to Home</a>
    </div>

    <!-- Loading State -->
    <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
      <svg class="animate-spin h-8 w-8 text-blue-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3">Loading products...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="hidden"></div>

  <!-- Product Grid -->
  <div id="grid" class="hidden mt-6"></div>
  <pre id="venue-debug-list" class="whitespace-pre-wrap text-xs text-gray-500 mt-4"></pre>

  <script>
    // Configuration
    const VENUE_API_ENDPOINT = "{% url 'venue:show_json_venue' %}";
    const CURRENT_USER_ID = String({{ user.id|default_if_none:'null' }} || '');

    // DOM elements
    const loadingSpinner = document.getElementById('loading');
    const errorMessage = document.getElementById('error');
    const eventGridContainer = document.getElementById('grid');
    const debugListEl = document.getElementById('venue-debug-list');

    function showLoading() {
      if (loadingSpinner && loadingSpinner.classList) loadingSpinner.classList.remove('hidden');
      if (errorMessage && errorMessage.classList) errorMessage.classList.add('hidden');
    }

    function showError(msg) {
      if (loadingSpinner && loadingSpinner.classList) loadingSpinner.classList.add('hidden');
      if (errorMessage) {
        errorMessage.classList.remove('hidden');
        errorMessage.innerHTML = `<div class="bg-red-50 border border-red-100 text-red-700 p-4 rounded">${DOMPurify.sanitize(msg)}</div>`;
      }
    }

    function clearError() {
      if (errorMessage && errorMessage.classList) errorMessage.classList.add('hidden');
    }

    function clearGrid() {
      if (eventGridContainer) eventGridContainer.innerHTML = '';
    }

    function getReadableCategoryName(code) {
      const map = { concert:'Concert', sports:'Sports', theater:'Theater', conference:'Conference', exhibition:'Exhibition', other:'Other' };
      return map[code] || code || 'Other';
    }

    function buildVenueCard(item) {
  const article = document.createElement('article');
  // add margin so each card has breathing room from its neighbors and the grid edges
  article.className = 'm-2 bg-white rounded-lg border-2 border-gray-300 hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full';

      // image area
      const imgWrap = document.createElement('div');
      imgWrap.className = 'aspect-square relative overflow-hidden';
      if (item.thumbnail) {
        const img = document.createElement('img');
        img.src = DOMPurify.sanitize(item.thumbnail);
        img.alt = DOMPurify.sanitize(item.name || '');
        img.className = 'w-full h-full object-cover';
        imgWrap.appendChild(img);
      } else {
        const placeholder = document.createElement('div');
        placeholder.className = 'w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center';
        placeholder.innerText = 'No image';
        imgWrap.appendChild(placeholder);
      }

      // body
      const body = document.createElement('div');
      body.className = 'p-4 flex flex-col flex-1';

      const topRow = document.createElement('div');
      topRow.className = 'flex items-center gap-2 mb-3';
      const cat = document.createElement('span');
      cat.className = 'inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-blue-600 text-white';
      cat.textContent = getReadableCategoryName(item.category);
      topRow.appendChild(cat);
      const status = document.createElement('div');
      status.innerHTML = item.is_accepted ? '<span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium bg-green-100 text-green-800">Accepted</span>' : '<span class="inline-flex items-center px-2 py-0.5 rounded-md text-xs font-medium bg-yellow-100 text-yellow-800">Pending</span>';
      topRow.appendChild(status);

      const h3 = document.createElement('h3');
      h3.className = 'text-lg font-semibold text-gray-900 mb-3 line-clamp-2 leading-tight';
      const a = document.createElement('a');
      a.href = `{% url 'venue:venue_detail' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);
      a.className = 'hover:text-blue-600 transition-colors text-3xl';
      a.textContent = item.name || '';
      h3.appendChild(a);

  // description intentionally omitted per UI request

      const loc = document.createElement('div');
      loc.className = 'text-sm text-gray-500 mb-3';
      loc.textContent = 'Location: ' + (item.location || 'Unknown');


      const footer = document.createElement('div');
      footer.className = 'pt-4 border-t border-gray-200 flex items-center justify-between mt-auto';
      const view = document.createElement('a');
      view.href = a.href;
      view.className = 'text-blue-600 hover:text-green-700 font-medium text-sm transition-colors';
      view.textContent = 'View';
      footer.appendChild(view);

      // owner actions (if current user owns it)
      if (CURRENT_USER_ID && item.owner_id && String(CURRENT_USER_ID) === String(item.owner_id)) {
        const actions = document.createElement('div');
        actions.className = 'flex space-x-2';
        const btnEdit = document.createElement('button');
        btnEdit.className = 'text-gray-600 hover:text-gray-700 text-sm';
        btnEdit.textContent = 'Edit';
        btnEdit.onclick = () => { window.location.href = a.href + 'edit/'; };
        const btnDel = document.createElement('button');
        btnDel.className = 'text-red-600 hover:text-red-700 text-sm';
        btnDel.textContent = 'Delete';
        btnDel.onclick = () => { if (confirm(`Delete venue "${item.name}"?`)) alert('Delete not implemented'); };
        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);
        footer.appendChild(actions);
      }

      body.appendChild(topRow);
  body.appendChild(h3);
  body.appendChild(loc);
      body.appendChild(footer);

      article.appendChild(imgWrap);
      article.appendChild(body);
      return article;
    }

    function renderGrid(data) {
      clearError();
      // query grid at render time in case DOM changed
      const gridEl = document.getElementById('grid');
      if (!gridEl) {
        showError('Internal error: grid container not found in the page DOM.');
        console.error('[venue] renderGrid: #grid element not found');
        return;
      }
      // clear existing children
      gridEl.innerHTML = '';
      if (!Array.isArray(data) || data.length === 0) {
        if (debugListEl) debugListEl.textContent = 'No venues found.';
        gridEl.classList.add('hidden');
        if (loadingSpinner && loadingSpinner.classList) loadingSpinner.classList.add('hidden');
        return;
      }

      if (debugListEl) {
        debugListEl.textContent = data.slice(0,20).map((it,i)=>`${i+1}. ${it.name || '[no name]'} (${it.id})`).join('\n');
      }

      if (gridEl && gridEl.classList) {
  // add padding to the grid container and increase gap between items
  gridEl.className = 'grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 p-4';
        gridEl.classList.remove('hidden');
      }

      data.forEach(item => {
        try {
          const card = buildVenueCard(item);
          gridEl.appendChild(card);
        } catch (e) {
          console.error('Error building venue card', e, item);
        }
      });
    }

    async function fetchVenues() {
      showLoading();
      try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 8000);
        const resp = await fetch(VENUE_API_ENDPOINT, { credentials: 'same-origin', signal: controller.signal });
        clearTimeout(timeout);
        if (!resp.ok) throw new Error('Server returned ' + resp.status);
        const data = await resp.json();
        renderGrid(data);
      } catch (err) {
        console.error('Failed to load venues', err);
        showError('Failed to load venues.');
      } finally {
        if (loadingSpinner && loadingSpinner.classList) loadingSpinner.classList.add('hidden');
      }
    }

    document.addEventListener('DOMContentLoaded', fetchVenues);

    // end script
    </script>

    {% endblock content %}