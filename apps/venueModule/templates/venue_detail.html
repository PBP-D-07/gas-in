{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Venue Detail</title>
{% endblock meta %}

{% block content %}
<div class="bg-gray-50 w-full min-h-screen">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Back Navigation -->
        <div class="mb-6">
            <a href="{% url 'main:show_main' %}" class="text-gray-600 hover:text-gray-900 font-medium transition-colors">
                ← Back to Venues
            </a>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="bg-white rounded-lg border border-gray-200 p-12 text-center">
            <svg class="animate-spin h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <p class="text-gray-600 mt-3">Loading venue detail...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
            <div class="w-16 h-16 mx-auto mb-4">
                <div class="text-red-500 text-5xl">⚠️</div>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Failed to load venue</h3>
            <p class="text-gray-500">Please try again later.</p>
        </div>

        <!-- Venue Content -->
        <article id="article-content" class="bg-white rounded-lg border border-gray-200 overflow-hidden hidden">
            <div class="p-6 sm:p-8">
                <div id="badges-container" class="flex flex-wrap items-center gap-2 mb-4"></div>

                <h1 id="article-title" class="text-3xl sm:text-4xl font-bold text-gray-900 leading-tight mb-4"></h1>

                <div class="flex flex-wrap items-center text-sm text-gray-500 gap-4">
                    <time id="article-date"></time>
                    <span id="article-views"></span>
                </div>
            </div>

            <div id="featured-image-container" class="px-6 sm:px-8 hidden">
                <img id="featured-image" src="" alt="" class="w-full h-64 sm:h-80 lg:h-96 object-cover rounded-lg">
            </div>

            <div class="p-6 sm:p-8">
                <div class="prose prose-lg max-w-none">
                    <div id="article-content-text" class="text-gray-700 leading-relaxed whitespace-pre-line text-base sm:text-lg"></div>
                </div>
            </div>

            <div class="border-t border-gray-200 p-6 sm:p-8 bg-gray-50">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-medium text-gray-900">
                            <p id="article-author">Owner: </p>
                        </div>
                        <p class="text-sm text-gray-500">Owner</p>
                    </div>
                </div>
            </div>
        </article>
    </div>
</div>

<script>
// Configuration
const VENUE_ID = "{{ venue.id }}";
const VENUE_DETAIL_ENDPOINT = `{% url 'venue:show_json_by_id_venue' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', VENUE_ID);

// DOM Elements
const loadingState = document.getElementById('loading-state');
const errorState = document.getElementById('error-state');
const articleContent = document.getElementById('article-content');
const badgesContainer = document.getElementById('badges-container');
const articleTitle = document.getElementById('article-title');
const articleDate = document.getElementById('article-date');
const articleViews = document.getElementById('article-views');
const featuredImageContainer = document.getElementById('featured-image-container');
const featuredImage = document.getElementById('featured-image');
const articleContentText = document.getElementById('article-content-text');
const articleAuthor = document.getElementById('article-author');
// debug output
const venueDebug = document.createElement('pre');
venueDebug.id = 'venue-debug';
venueDebug.className = 'text-xs text-gray-500 mt-4 whitespace-pre-wrap';
if (articleContent && articleContent.parentNode) articleContent.parentNode.insertBefore(venueDebug, articleContent.nextSibling);

function showState(state) {
    if (loadingState) loadingState.classList.toggle('hidden', state !== 'loading');
    if (errorState) errorState.classList.toggle('hidden', state !== 'error');
    if (articleContent) articleContent.classList.toggle('hidden', state !== 'ready');
}

function getCategoryLabel(code) {
    const map = { concert:'Concert', sports:'Sports', theater:'Theater', conference:'Conference', exhibition:'Exhibition', other:'Other' };
    return map[code] || code || 'Other';
}

function renderVenue(v) {
    // Title
    if (!v) return;
    if (articleTitle) articleTitle.textContent = v.name || '';
    document.title = `${v.name || 'Venue'} - gas.in`;

    // Badges
    if (badgesContainer) {
        badgesContainer.innerHTML = '';
        const cat = document.createElement('span');
        cat.className = 'inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-blue-600 text-white';
        cat.textContent = getCategoryLabel(v.category);
        badgesContainer.appendChild(cat);

        const status = document.createElement('span');
        status.className = v.is_accepted ? 'inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-green-100 text-green-800' : 'inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-yellow-100 text-yellow-800';
        status.textContent = v.is_accepted ? 'Accepted' : 'Pending';
        badgesContainer.appendChild(status);
    }

    // Date & views (views not tracked for venues, leave empty)
    if (articleDate) {
        articleDate.textContent = v.created_at ? new Date(v.created_at).toLocaleString('id-ID') : '';
    }
    if (articleViews) articleViews.textContent = '';

    // Featured image
    try {
        if (v.thumbnail) {
            const url = String(v.thumbnail).startsWith('http') ? v.thumbnail : (window.location.origin + v.thumbnail);
            featuredImage.src = url;
            featuredImage.alt = v.name || '';
            featuredImageContainer.classList.remove('hidden');
        } else if (featuredImageContainer) {
            featuredImageContainer.classList.add('hidden');
        }
    } catch (e) {
        console.warn('Error setting thumbnail', e);
    }

    // Content
    if (articleContentText) articleContentText.innerHTML = DOMPurify.sanitize(v.description || '');

    // Owner
    if (articleAuthor) articleAuthor.textContent = `Owner ID: ${v.owner_id || ''}`;
}

async function loadVenueDetail() {
    try {
        showState('loading');
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 8000);
        const resp = await fetch(VENUE_DETAIL_ENDPOINT, { signal: controller.signal, credentials: 'same-origin' });
        clearTimeout(timeout);
        if (!resp.ok) throw new Error('Server returned ' + resp.status);
        let data = null;
        try {
            data = await resp.json();
        } catch (e) {
            throw new Error('Invalid JSON from server');
        }

        // API may return either the object itself or {"detail":...,} or similar.
        // Our endpoint returns the object directly; but be defensive.
        let venueObj = null;
        if (data && typeof data === 'object') {
            if (data.data) venueObj = data.data;
            else venueObj = data;
        }

        // debug dump
        if (venueDebug) venueDebug.textContent = JSON.stringify(venueObj, null, 2);

        renderVenue(venueObj);
        showState('ready');
    } catch (err) {
        console.error('Error loading venue detail:', err);
        showState('error');
    }
}

document.addEventListener('DOMContentLoaded', loadVenueDetail);
</script>

{% endblock content %}